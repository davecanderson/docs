import{_ as t}from"./chunks/migration-scripts.4545570b.js";import{_ as e,o,c as p,a as s,d as n,b as a}from"./app.2aea72c0.js";const q='{"title":"App Tasks","description":"","frontmatter":{"title":"App Tasks"},"headers":[{"level":3,"title":"Example","slug":"example"},{"level":2,"title":"DB Migration App Task","slug":"db-migration-app-task"},{"level":3,"title":"Running migrations from command-line","slug":"running-migrations-from-command-line"},{"level":3,"title":"Configuring existing Projects","slug":"configuring-existing-projects"},{"level":3,"title":"ASP .NET Core Projects","slug":"asp-net-core-projects"}],"relativePath":"app-tasks.md"}',c={},i=s(`<p>App Tasks let you run one-off tasks with the full context of your App but without the overhead of maintaining a separate <strong>.exe</strong> with duplicated App configuration. With App Tasks you can run your ASP .NET Core App, run the specified Tasks then exit before launching its HTTP Server.</p><h3 id="example" tabindex="-1">Example <a class="header-anchor" href="#example" aria-hidden="true">#</a></h3><p>The <code>AppTasks</code> static class can be used to register user-defined tasks, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> runner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskRunner</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Services<span class="token punctuation">)</span><span class="token punctuation">;</span>
AppTasks<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;task1&quot;</span><span class="token punctuation">,</span> args <span class="token operator">=&gt;</span> runner<span class="token punctuation">.</span><span class="token function">Task1</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AppTasks<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;task2&quot;</span><span class="token punctuation">,</span> args <span class="token operator">=&gt;</span> runner<span class="token punctuation">.</span><span class="token function">Task2</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AppTasks<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Which can then be run from the command-line with:</p>`,5),r=n("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[n("div",{class:"flex-grow bg-gray-800"},[n("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[n("p",null,"dotnet run --AppTasks=task1:arg1,arg2;task2:arg1,arg2")])]),n("div",{class:"flex"},[n("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[n("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),n("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),l=s('<p>Which will run the tasks in the specified order, before immediately exiting. If any of the tasks fail the command will return the 1-based index of the task that failed, otherwise it will return a <strong>0</strong> success result.</p><h2 id="db-migration-app-task" tabindex="-1">DB Migration App Task <a class="header-anchor" href="#db-migration-app-task" aria-hidden="true">#</a></h2><p>For a more complete example we&#39;ll look at how <a href="/ormlite/db-migrations">code-first DB Migrations</a> uses App Tasks to run DB Migrations from the command-line.</p><h3 id="running-migrations-from-command-line" tabindex="-1">Running migrations from command-line <a class="header-anchor" href="#running-migrations-from-command-line" aria-hidden="true">#</a></h3><p>To be able to run from migrations from the command line, DB Migrations needs access to your App&#39;s DB configuration. The best way to do this is to run your App normally then access the configured <code>IDbConnectionFactory</code> from the IOC, perform the migrations then exit with either a success or failure error code.</p><p>To do this we&#39;ve added support for <strong>AppTasks</strong> which let you define tasks in your App that you can run from the command-line. This will let you perform migrations in a separate stage to check migrations were successful before running your App.</p><h3 id="configuring-existing-projects" tabindex="-1">Configuring existing Projects <a class="header-anchor" href="#configuring-existing-projects" aria-hidden="true">#</a></h3><p>You can add DB Migration support to existing projects by applying the <a href="https://gist.github.com/gistlyn/50df00df4b3b9faa94a73d32ab4b2484" target="_blank" rel="noopener noreferrer">migrations</a> gist to your project with:</p>',8),u=n("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[n("div",{class:"flex-grow bg-gray-800"},[n("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[n("p",null,"x mix migrations")])]),n("div",{class:"flex"},[n("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[n("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),n("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),k=s(`<p>This will register the Migration <strong>AppTasks</strong> with your App via a <a href="https://docs.servicestack.net/modular-startup" target="_blank" rel="noopener noreferrer">Modular Startup</a> configuration:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigureDbMigrations</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHostingStartup</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IWebHostBuilder</span> builder<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> builder
        <span class="token punctuation">.</span><span class="token function">ConfigureAppHost</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">afterAppHostInit</span><span class="token punctuation">:</span>appHost <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> migrator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Migrator</span><span class="token punctuation">(</span>appHost<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Migration1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span><span class="token punctuation">;</span>
            AppTasks<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;migrate&quot;</span><span class="token punctuation">,</span> _ <span class="token operator">=&gt;</span> migrator<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            AppTasks<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;migrate.revert&quot;</span><span class="token punctuation">,</span> args <span class="token operator">=&gt;</span> migrator<span class="token punctuation">.</span><span class="token function">Revert</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            AppTasks<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Here we can see we need to configure our <code>Migrator</code> with the <code>IDbConnectionFactory</code> we want to run against and the assemblies where all our Migration classes are maintained. It also registers an AppTasks to <strong>migrate</strong> our App by comparing the <strong>Migration</strong> table with the Migrations in the specified Assembly to workout which Migrations are left to run (in order) and the <strong>revert</strong> AppTask to do the opposite and revert to the specified migration.</p><p>This will now let us run your app in <strong>&quot;Task Mode&quot;</strong> where it will execute the specified task before promptly exiting with a <strong>0</strong> success exit code if successful or the index of the task that failed, e.g. <strong>1</strong> if the first Task failed.</p><p>We can then execute our App Task by running our App with the <code>AppTasks</code> command-line argument of the Task we want to run, so we can run all pending migrations with:</p>`,5),g=n("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[n("div",{class:"flex-grow bg-gray-800"},[n("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[n("p",null,"dotnet run --AppTasks=migrate")])]),n("div",{class:"flex"},[n("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[n("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),n("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),d=s(`<p>The format to revert a migration is:</p><div class="language-bash"><pre><code>$ dotnet run <span class="token parameter variable">--AppTasks</span><span class="token operator">=</span>migrate.revert:<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>
</code></pre></div><p>Where <strong>name</strong> is either the class name of the Migration you want to revert to (inclusive) or you can use <strong>last</strong> to revert the last migration:</p>`,3),h=n("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[n("div",{class:"flex-grow bg-gray-800"},[n("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[n("p",null,"dotnet run --AppTasks=migrate.revert:last")])]),n("div",{class:"flex"},[n("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[n("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),n("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),m=n("p",null,[a("or "),n("strong",null,"all"),a(" to revert all migrations:")],-1),w=n("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[n("div",{class:"flex-grow bg-gray-800"},[n("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[n("p",null,"dotnet run --AppTasks=migrate.revert:all")])]),n("div",{class:"flex"},[n("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[n("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),n("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),f=s(`<p>To make this easier to remember and use, these tasks are also added as npm scripts:</p><div class="language-csharp"><pre><code><span class="token punctuation">{</span>
  <span class="token string">&quot;scripts&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;migrate&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;dotnet run --AppTasks=migrate&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;revert:last&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;dotnet run --AppTasks=migrate.revert:last&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;revert:all&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;dotnet run --AppTasks=migrate.revert:all&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Which can be run with:</p><div class="language-bash"><pre><code>$ <span class="token function">npm</span> run migrate
$ <span class="token function">npm</span> run revert:last
$ <span class="token function">npm</span> run revert:all
</code></pre></div><p>Which Rider provides a nice UX for running directly from the IDE where it will print all executed SQL output in a dedicated Console:</p><p><img src="`+t+`" alt=""></p><h3 id="asp-net-core-projects" tabindex="-1">ASP .NET Core Projects <a class="header-anchor" href="#asp-net-core-projects" aria-hidden="true">#</a></h3><p>General (i.e. non-ServiceStack) <a href="http://ASP.NET" target="_blank" rel="noopener noreferrer">ASP.NET</a> Core Apps can instead configure AppTasks before <code>app.Run()</code> in their <strong>Program.cs</strong>:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> migrator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Migrator</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Migrations<span class="token punctuation">.</span>Migration1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span><span class="token punctuation">;</span>
AppTasks<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;migrate&quot;</span><span class="token punctuation">,</span> _ <span class="token operator">=&gt;</span> migrator<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AppTasks<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;migrate.revert&quot;</span><span class="token punctuation">,</span> args <span class="token operator">=&gt;</span> migrator<span class="token punctuation">.</span><span class="token function">Revert</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AppTasks<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>`,9),v=[i,r,l,u,k,g,d,h,m,w,f];function _(x,y,T,b,A,M){return o(),p("div",null,v)}var R=e(c,[["render",_]]);export{q as __pageData,R as default};
